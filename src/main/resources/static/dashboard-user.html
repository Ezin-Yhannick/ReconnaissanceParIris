<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IrisAuth - Tableau de bord Utilisateur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen flex flex-col" x-data="dashboardUser()">
    
    <div id="header"></div>

    <div class="flex flex-1">
        <div id="sidebar"></div>

        <main class="flex-1 p-6 flex items-center justify-center">
            <div class="w-full max-w-4xl">
                <div class="mb-6 text-center">
                    <h2 class="text-2xl font-bold text-gray-800">Bienvenue, <span x-text="userFullName"></span> üëã</h2>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <!-- Quick Authentication (3/5) -->
                    <div class="lg:col-span-3 bg-white rounded-xl shadow-lg p-5">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Authentification rapide par iris</h3>
                        
                        <div class="text-center py-4">
                            <div class="relative inline-block mb-4">
                                <div 
                                    @click="showIrisModal = true" 
                                    class="w-24 h-24 mx-auto bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 rounded-full flex items-center justify-center cursor-pointer transform hover:scale-110 transition-all duration-300 shadow-xl">
                                    <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                    </svg>
                                </div>
                            </div>
                            
                            <div x-show="!scanComplete">
                                <p class="text-gray-600 mb-3 text-sm">Cliquez sur l'ic√¥ne pour scanner votre iris</p>
                                <button 
                                    @click="showIrisModal = true"
                                    class="px-5 py-2 bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-white rounded-lg font-semibold hover:shadow-xl transform hover:scale-105 transition-all text-sm">
                                    Scanner mon iris
                                </button>
                            </div>

                            <div x-show="scanComplete">
                                <div class="text-green-600 mb-3">
                                    <svg class="w-10 h-10 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <p class="text-green-600 font-bold">Authentification r√©ussie !</p>
                                <p class="text-gray-500 mt-1 text-sm">Taux de correspondance: <span class="font-bold text-indigo-600" x-text="userStats.matchRate + '%'"></span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column (2/5) -->
                    <div class="lg:col-span-2 space-y-5">
                        <!-- User Info Card -->
                        <div class="bg-white rounded-xl shadow-lg p-5">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Mes informations</h3>
                            <div class="space-y-3">
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                    <div class="bg-indigo-100 p-2 rounded-lg">
                                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500 font-semibold uppercase">Nom complet</p>
                                        <p class="text-sm font-bold text-gray-800" x-text="userFullName"></p>
                                    </div>
                                </div>

                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                    <div class="bg-purple-100 p-2 rounded-lg">
                                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1 overflow-hidden">
                                        <p class="text-xs text-gray-500 font-semibold uppercase">Email</p>
                                        <p class="text-sm font-bold text-gray-800 break-all" x-text="userEmail"></p>
                                    </div>
                                </div>

                                <button 
                                    @click="window.location.href='profile-user.html'"
                                    class="w-full py-2.5 bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm transform hover:scale-105">
                                    Voir plus
                                </button>
                            </div>
                        </div>

                        <!-- Taux de correspondance -->
                        <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow-lg p-5 text-white transform hover:scale-105 transition-all">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs opacity-90 font-semibold uppercase tracking-wide">Taux de correspondance</p>
                                    <p class="text-3xl font-bold mt-2" x-text="userStats.matchRate + '%'"></p>
                                    <p class="text-xs opacity-90 mt-1">Connexion actuelle</p>
                                </div>
                                <div class="bg-white/20 rounded-full p-3">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Iris Authentication Modal -->
    <div x-show="showIrisModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4"
         @click.self="closeModal()">
        
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-8"
             x-transition:enter="transition ease-out duration-300 transform"
             x-transition:enter-start="scale-95 opacity-0"
             x-transition:enter-end="scale-100 opacity-100"
             @click.stop>
            
            <!-- Modal Header -->
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Authentification par iris</h3>
                <button @click="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Authentication Method Tabs -->
            <div class="flex space-x-2 mb-6 bg-gray-100 p-1 rounded-lg">
                <button 
                    @click="authMethod = 'upload'"
                    :class="authMethod === 'upload' ? 'bg-white shadow' : 'hover:bg-gray-200'"
                    class="flex-1 py-2 rounded-lg font-semibold transition-all text-gray-700">
                    Uploader une photo
                </button>
                <button 
                    @click="authMethod = 'camera'"
                    :class="authMethod === 'camera' ? 'bg-white shadow' : 'hover:bg-gray-200'"
                    class="flex-1 py-2 rounded-lg font-semibold transition-all text-gray-700">
                    Scanner avec cam√©ra
                </button>
            </div>

            <!-- Upload Photo Method -->
            <div x-show="authMethod === 'upload'" class="space-y-4">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-indigo-500 transition-colors cursor-pointer"
                     @click="$refs.fileInput.click()">
                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <p class="text-gray-600 mb-2">Cliquez pour s√©lectionner une photo de votre iris</p>
                    <p class="text-sm text-gray-400">Format accept√©: JPG, PNG</p>
                    <input type="file" x-ref="fileInput" @change="handleFileUpload($event)" accept="image/*" class="hidden">
                </div>
                
                <div x-show="uploadedFile" class="bg-gray-50 rounded-lg p-4 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span class="text-gray-700 font-medium" x-text="uploadedFileName"></span>
                    </div>
                    <button @click="uploadedFile = null; uploadedFileName = ''" class="text-red-500 hover:text-red-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <button 
                    @click="authenticateWithUpload"
                    :disabled="!uploadedFile"
                    :class="uploadedFile ? 'bg-gradient-to-r from-indigo-600 to-purple-600 hover:shadow-xl' : 'bg-gray-300 cursor-not-allowed'"
                    class="w-full text-white py-3 rounded-lg font-semibold transform hover:scale-105 transition-all">
                    Authentifier
                </button>
            </div>

            <!-- Camera Scan Method -->
            <div x-show="authMethod === 'camera'" class="space-y-4">
                <div class="bg-gray-900 rounded-lg aspect-video flex items-center justify-center relative overflow-hidden">
                    <div x-show="!cameraActive" class="text-center">
                        <svg class="w-20 h-20 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                        <p class="text-gray-400">Cam√©ra non activ√©e</p>
                    </div>
                    <video x-show="cameraActive" x-ref="videoElement" autoplay playsinline class="w-full h-full object-cover"></video>
                    
                    <!-- Iris scanning overlay -->
                    <div x-show="cameraActive" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div class="w-48 h-48 border-4 border-white/50 rounded-full"></div>
                        <div class="absolute w-48 h-48 border-4 border-indigo-500 rounded-full animate-ping"></div>
                    </div>
                </div>

                <div class="flex space-x-3">
                    <button 
                        @click="toggleCamera"
                        class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:shadow-xl transition-all">
                        <span x-text="cameraActive ? 'Arr√™ter la cam√©ra' : 'Activer la cam√©ra'"></span>
                    </button>
                    <button 
                        @click="captureIris"
                        :disabled="!cameraActive"
                        :class="cameraActive ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-300 cursor-not-allowed'"
                        class="flex-1 text-white py-3 rounded-lg font-semibold transition-all">
                        Scanner
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer"></div>

    <script src="assets/js/main.js"></script>
    <script>
        function dashboardUser() {
            return {
                userId: null,
                userFullName: 'Utilisateur',
                userEmail: '',
                scanComplete: false,
                showIrisModal: false,
                authMethod: 'upload',
                uploadedFile: null,
                uploadedFileName: '',
                cameraActive: false,
                videoStream: null,
                userStats: {
                    matchRate: 0
                },
                
                async init() {
                    console.log('üîç Initialisation dashboard utilisateur...');
                    
                    // V√©rifier si l'utilisateur est connect√©
                    const userRole = localStorage.getItem('userRole');
                    const userId = localStorage.getItem('userId');
                    
                    console.log('userRole:', userRole);
                    console.log('userId:', userId);
                    
                    if (userRole !== 'user' || !userId) {
                        console.log('‚ùå Acc√®s non autoris√©, redirection...');
                        IrisAuth.showNotification('‚ö†Ô∏è Acc√®s r√©serv√© aux utilisateurs', 'error');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 1500);
                        return;
                    }
                    
                    // Charger les composants
                    this.loadComponents();
                    
                    // Charger les donn√©es utilisateur
                    await this.loadUserData();
                    
                    console.log('‚úÖ Dashboard initialis√©');
                    console.log('userFullName:', this.userFullName);
                    console.log('userEmail:', this.userEmail);
                    console.log('matchRate:', this.userStats.matchRate);
                },
                                
 async loadUserData() {
    try {
        console.log('üì• Chargement des donn√©es utilisateur...');
        
        // R√©cup√©rer l'ID utilisateur
        this.userId = localStorage.getItem('userId');
        
        // √âTAPE 1 : Charger depuis localStorage d'abord
        let firstName = localStorage.getItem('userFirstName') || '';
        let lastName = localStorage.getItem('userLastName') || '';
        let email = localStorage.getItem('userEmail') || '';
        let matchRate = localStorage.getItem('lastMatchRate') || '0';
        
        console.log('üì¶ localStorage - donn√©es actuelles:');
        console.log('  - firstName:', firstName);
        console.log('  - lastName:', lastName);
        console.log('  - email:', email);
        console.log('  - matchRate:', matchRate);
        
        // Afficher imm√©diatement les donn√©es du localStorage
        if (firstName && lastName) {
            this.userFullName = `${firstName} ${lastName}`.trim();
            this.userEmail = email;
            this.userStats.matchRate = parseFloat(matchRate) || 0;
            console.log('‚úÖ Affichage des donn√©es localStorage');
        }
        
        // √âTAPE 2 : Essayer de charger depuis l'API pour rafra√Æchir
        if (this.userId) {
            try {
                const response = await IrisAuth.apiGet(`/users/${this.userId}`);
                console.log('üåê R√©ponse API compl√®te:', response);
                
                // G√©rer le format {user: {...}, status: 'success'}
                let userData = null;
                
                if (response.user) {
                    userData = response.user;
                    console.log('üë§ userData extraite de response.user:', userData);
                } else if (response.prenom || response.nom) {
                    userData = response;
                    console.log('üë§ userData = response direct:', userData);
                }
                
                if (userData && userData.prenom && userData.nom) {
                    // Mettre √† jour avec les donn√©es fra√Æches de l'API
                    firstName = userData.prenom;
                    lastName = userData.nom;
                    email = userData.email || email;
                    
                    // Mettre √† jour l'affichage
                    this.userFullName = `${firstName} ${lastName}`.trim();
                    this.userEmail = email;
                    
                    // Sauvegarder dans localStorage pour la persistance
                    localStorage.setItem('userFirstName', firstName);
                    localStorage.setItem('userLastName', lastName);
                    localStorage.setItem('userEmail', email);
                    
                    console.log('‚úÖ Donn√©es mises √† jour depuis API et sauvegard√©es');
                }
            } catch (apiError) {
                console.log('‚ö†Ô∏è Erreur API (on garde localStorage):', apiError);
            }
        }
        
        console.log('‚úÖ Donn√©es finales affich√©es:');
        console.log('  - userFullName:', this.userFullName);
        console.log('  - userEmail:', this.userEmail);
        console.log('  - matchRate:', this.userStats.matchRate);
        
    } catch (error) {
        console.error('‚ùå Erreur critique loadUserData:', error);
        
        // Dernier recours : utiliser localStorage
        const firstName = localStorage.getItem('userFirstName') || '';
        const lastName = localStorage.getItem('userLastName') || '';
        this.userFullName = `${firstName} ${lastName}`.trim() || 'Utilisateur';
        this.userEmail = localStorage.getItem('userEmail') || '';
        this.userStats.matchRate = parseFloat(localStorage.getItem('lastMatchRate') || '0');
    }
},
                
                loadComponents() {
                    fetch('components/header-user.html')
                        .then(r => r.text())
                        .then(html => document.getElementById('header').innerHTML = html);

                    fetch('components/footer.html')
                        .then(r => r.text())
                        .then(html => document.getElementById('footer').innerHTML = html);
                },
                
                handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (file && IrisAuth.isValidImageFile(file)) {
                        this.uploadedFile = file;
                        this.uploadedFileName = file.name;
                    }
                },
                
async authenticateWithUpload() {
    if (!this.uploadedFile) return;
    
    try {
        IrisAuth.showLoader('üîç Analyse de l\'iris en cours...');
        
        const formData = new FormData();
        formData.append('irisImage', this.uploadedFile);
        
        const result = await IrisAuth.apiPostFormData('/iris/authenticate', formData);
        
        IrisAuth.hideLoader();
        
        console.log('üîç R√âSULTAT AUTHENTIFICATION COMPLET:', result);
        console.log('  - success:', result.success);
        console.log('  - matchRate:', result.matchRate);
        console.log('  - matchScore:', result.matchScore);
        console.log('  - message:', result.message);
        console.log('  - user:', result.user);
        console.log('  - Structure compl√®te:', JSON.stringify(result, null, 2));
        
        if (result.success) {
            this.userStats.matchRate = result.matchRate || result.matchScore || 98.5;
            localStorage.setItem('lastMatchRate', this.userStats.matchRate);
            
            this.showIrisModal = false;
            this.scanComplete = true;
            this.uploadedFile = null;
            this.uploadedFileName = '';
            
            IrisAuth.showNotification(`‚úÖ Authentification r√©ussie ! (${this.userStats.matchRate}%)`, 'success');
            
            setTimeout(() => {
                this.scanComplete = false;
            }, 5000);
        } else {
            IrisAuth.showNotification('‚ùå ' + (result.message || '√âchec de l\'authentification'), 'error');
        }
    } catch (error) {
        IrisAuth.hideLoader();
        console.error('‚ùå Erreur authentification:', error);
        
        // Afficher un message clair √† l'utilisateur
        IrisAuth.showNotification(error.message || '‚ùå Erreur lors de l\'authentification', 'error');
    }
},
                
                async toggleCamera() {
                    if (this.cameraActive) {
                        this.stopCamera();
                    } else {
                        await this.startCamera();
                    }
                },
                
                async startCamera() {
                    try {
                        this.videoStream = await navigator.mediaDevices.getUserMedia({ 
                            video: { facingMode: 'user' } 
                        });
                        this.$refs.videoElement.srcObject = this.videoStream;
                        this.cameraActive = true;
                    } catch (error) {
                        IrisAuth.showNotification('‚ùå Impossible d\'acc√©der √† la cam√©ra', 'error');
                        console.error('Camera error:', error);
                    }
                },
                
                stopCamera() {
                    if (this.videoStream) {
                        this.videoStream.getTracks().forEach(track => track.stop());
                        this.videoStream = null;
                    }
                    this.cameraActive = false;
                },
                
                async captureIris() {
                    if (!this.cameraActive) return;
                    
                    try {
                        // Capturer l'image de la cam√©ra
                        const canvas = document.createElement('canvas');
                        const video = this.$refs.videoElement;
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        canvas.getContext('2d').drawImage(video, 0, 0);

                        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
                        const file = new File([blob], 'iris-capture.jpg', { type: 'image/jpeg' });

                        this.stopCamera();
                        
                        IrisAuth.showLoader('üîç Analyse de l\'iris en cours...');
                        
                        const formData = new FormData();
                        formData.append('irisImage', file);
                        
                        const result = await IrisAuth.apiPostFormData('/iris/authenticate', formData);
                        
                        IrisAuth.hideLoader();
                        
                        if (result.success) {
                            this.userStats.matchRate = result.matchRate || 98.5;
                            localStorage.setItem('lastMatchRate', this.userStats.matchRate);
                            
                            this.showIrisModal = false;
                            this.scanComplete = true;
                            
                            IrisAuth.showNotification('‚úÖ Authentification r√©ussie !', 'success');
                            
                            setTimeout(() => {
                                this.scanComplete = false;
                            }, 5000);
                        } else {
                            IrisAuth.showNotification('‚ùå ' + (result.message || '√âchec de l\'authentification'), 'error');
                        }
                    } catch (error) {
                        IrisAuth.hideLoader();
                        console.error('Erreur capture:', error);
                        IrisAuth.showNotification('‚ùå Erreur lors de la capture', 'error');
                    }
                },
                
                closeModal() {
                    this.stopCamera();
                    this.showIrisModal = false;
                    this.uploadedFile = null;
                    this.uploadedFileName = '';
                }
            }
        }
    </script>
</body>
</html>